/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("filemanager",function(e){function t(e,t,n){return e+" ("+Math.ceil(t/1024)+"KB, "+n+")"}function n(e,n){n.is_dir?e.attr("title",n.filename):e.attr("title",t(n.filename,n.filesize,n.datetime))}var i=this,a="filemanager",r=e.undef(i.fileManagerJson,i.basePath+"php/file_manager_json.php"),o=i.pluginsPath+a+"/images/",s=i.lang(a+".");i.plugin.filemanagerDialog=function(t){function l(t,n,a){var o="path="+t+"&order="+n+"&dir="+f;b.showLoading(i.lang("ajaxLoading")),e.ajax(e.addParam(r,o+"&"+(new Date).getTime()),function(e){b.hideLoading(),a(e)})}function c(t,n,i,a){var r=e.formatUrl(n.current_url+i.filename,"absolute"),o=encodeURIComponent(n.current_dir_path+i.filename+"/");i.is_dir?t.click(function(){l(o,C.val(),a)}):i.is_photo?t.click(function(){v.call(this,r,i.filename)}):t.click(function(){v.call(this,r,i.filename)}),N.push(t)}function d(t,n){function i(){"VIEW"==S.val()?l(t.current_dir_path,C.val(),p):l(t.current_dir_path,C.val(),u)}e.each(N,function(){this.unbind()}),x.unbind(),S.unbind(),C.unbind(),t.current_dir_path&&x.click(function(){l(t.moveup_dir_path,C.val(),n)}),S.change(i),C.change(i),k.html("")}function u(t){d(t,u);var n=document.createElement("table");n.className="ke-table",n.cellPadding=0,n.cellSpacing=0,n.border=0,k.append(n);for(var i=t.file_list,a=0,r=i.length;r>a;a++){var l=i[a],p=e(n.insertRow(a));p.mouseover(function(){e(this).addClass("ke-on")}).mouseout(function(){e(this).removeClass("ke-on")});var h=o+(l.is_dir?"folder-16.gif":"file-16.gif"),m=e('<img src="'+h+'" width="16" height="16" alt="'+l.filename+'" align="absmiddle" />'),f=e(p[0].insertCell(0)).addClass("ke-cell ke-name").append(m).append(document.createTextNode(" "+l.filename));!l.is_dir||l.has_file?(p.css("cursor","pointer"),f.attr("title",l.filename),c(f,t,l,u)):f.attr("title",s.emptyFolder),e(p[0].insertCell(1)).addClass("ke-cell ke-size").html(l.is_dir?"-":Math.ceil(l.filesize/1024)+"KB"),e(p[0].insertCell(2)).addClass("ke-cell ke-datetime").html(l.datetime)}}function p(t){d(t,p);for(var i=t.file_list,a=0,r=i.length;r>a;a++){var l=i[a],u=e('<div class="ke-inline-block ke-item"></div>');k.append(u);var h=e('<div class="ke-inline-block ke-photo"></div>').mouseover(function(){e(this).addClass("ke-on")}).mouseout(function(){e(this).removeClass("ke-on")});u.append(h);var m=t.current_url+l.filename,f=l.is_dir?o+"folder-64.gif":l.is_photo?m:o+"file-64.gif",g=e('<img src="'+f+'" width="80" height="80" alt="'+l.filename+'" />');!l.is_dir||l.has_file?(h.css("cursor","pointer"),n(h,l),c(h,t,l,p)):h.attr("title",s.emptyFolder),h.append(g),u.append('<div class="ke-name" title="'+l.filename+'">'+l.filename+"</div>")}}var h=e.undef(t.width,650),m=e.undef(t.height,510),f=e.undef(t.dirName,""),g=e.undef(t.viewType,"VIEW").toUpperCase(),v=t.clickFn,y=['<div style="padding:10px 20px;">','<div class="ke-plugin-filemanager-header">','<div class="ke-left">','<img class="ke-inline-block" name="moveupImg" src="'+o+'go-up.gif" width="16" height="16" border="0" alt="" /> ','<a class="ke-inline-block" name="moveupLink" href="javascript:;">'+s.moveup+"</a>","</div>",'<div class="ke-right">',s.viewType+' <select class="ke-inline-block" name="viewType">','<option value="VIEW">'+s.viewImage+"</option>",'<option value="LIST">'+s.listImage+"</option>","</select> ",s.orderType+' <select class="ke-inline-block" name="orderType">','<option value="NAME">'+s.fileName+"</option>",'<option value="SIZE">'+s.fileSize+"</option>",'<option value="TYPE">'+s.fileType+"</option>","</select>","</div>",'<div class="ke-clearfix"></div>',"</div>",'<div class="ke-plugin-filemanager-body"></div>',"</div>"].join(""),b=i.createDialog({name:a,width:h,height:m,title:i.lang(a),body:y}),w=b.div,k=e(".ke-plugin-filemanager-body",w),x=(e('[name="moveupImg"]',w),e('[name="moveupLink"]',w)),S=(e('[name="viewServer"]',w),e('[name="viewType"]',w)),C=e('[name="orderType"]',w),N=[];return S.val(g),l("",C.val(),"VIEW"==g?p:u),b}});