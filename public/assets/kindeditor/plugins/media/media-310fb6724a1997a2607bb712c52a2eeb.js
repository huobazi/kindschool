/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("media",function(e){var t=this,a="media",i=t.lang(a+"."),n=e.undef(t.allowMediaUpload,!0),l=e.undef(t.allowFileManager,!1),o=e.undef(t.formatUploadUrl,!0),r=e.undef(t.extraFileUploadParams,{}),s=e.undef(t.filePostName,"imgFile"),d=e.undef(t.uploadJson,t.basePath+"php/upload_json.php");t.plugin.media={edit:function(){var c=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keUrl" style="width:60px;">'+i.url+"</label>",'<input class="ke-input-text" type="text" id="keUrl" name="url" value="" style="width:160px;" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+i.upload+'" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+i.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:60px;">'+i.width+"</label>",'<input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="550" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keHeight" style="width:60px;">'+i.height+"</label>",'<input type="text" id="keHeight" class="ke-input-text ke-input-number" name="height" value="400" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAutostart">'+i.autostart+"</label>",'<input type="checkbox" id="keAutostart" name="autostart" value="" /> ',"</div>","</div>"].join(""),u=t.createDialog({name:a,width:450,height:230,title:t.lang(a),body:c,yesBtn:{name:t.lang("yes"),click:function(){var a=e.trim(m.val()),i=h.val(),n=f.val();if("http://"==a||e.invalidUrl(a))return alert(t.lang("invalidUrl")),m[0].focus(),void 0;if(!/^\d*$/.test(i))return alert(t.lang("invalidWidth")),h[0].focus(),void 0;if(!/^\d*$/.test(n))return alert(t.lang("invalidHeight")),f[0].focus(),void 0;var l=e.mediaImg(t.themesPath+"common/blank.gif",{src:a,type:e.mediaType(a),width:i,height:n,autostart:v[0].checked?"true":"false",loop:"true"});t.insertHtml(l).hideDialog().focus()}}}),p=u.div,m=e('[name="url"]',p),g=e('[name="viewServer"]',p),h=e('[name="width"]',p),f=e('[name="height"]',p),v=e('[name="autostart"]',p);if(m.val("http://"),n){var b=e.uploadbutton({button:e(".ke-upload-button",p)[0],fieldName:s,extraParams:r,url:e.addParam(d,"dir=media"),afterUpload:function(i){if(u.hideLoading(),0===i.error){var n=i.url;o&&(n=e.formatUrl(n,"absolute")),m.val(n),t.afterUpload&&t.afterUpload.call(t,n,i,a),alert(t.lang("uploadSuccess"))}else alert(i.message)},afterError:function(e){u.hideLoading(),t.errorDialog(e)}});b.fileBox.change(function(){u.showLoading(t.lang("uploadLoading")),b.submit()})}else e(".ke-upload-button",p).hide();l?g.click(function(){t.loadPlugin("filemanager",function(){t.plugin.filemanagerDialog({viewType:"LIST",dirName:"media",clickFn:function(a){t.dialogs.length>1&&(e('[name="url"]',p).val(a),t.afterSelectFile&&t.afterSelectFile.call(t,a),t.hideDialog())}})})}):g.hide();var k=t.plugin.getSelectedMedia();if(k){var y=e.mediaAttrs(k.attr("data-ke-tag"));m.val(y.src),h.val(e.removeUnit(k.css("width"))||y.width||0),f.val(e.removeUnit(k.css("height"))||y.height||0),v[0].checked="true"===y.autostart}m[0].focus(),m[0].select()},"delete":function(){t.plugin.getSelectedMedia().remove(),t.addBookmark()}},t.clickToolbar(a,t.plugin.media.edit)});